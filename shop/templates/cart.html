{% extends "base.html" %}
{% block content %}
    <h1>Корзина</h1>

    {% if cart_items %}
        {% for item in cart_items %}
            <div style="display:flex;gap:25px;background:var(--card-bg);padding:25px;border-radius:20px;margin-bottom:25px;backdrop-filter:blur(10px);">
                {% if item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" style="width:140px;height:140px;object-fit:cover;border-radius:16px;">
                {% else %}
                    <div style="width:140px;height:140px;background:#333;border-radius:16px;"></div>
                {% endif %}
                <div style="flex:1;">
                    <h3>{{ item.product.name }}</h3>
                    
                    <!-- Проверка остатка -->
                    {% if item.product.stock < item.quantity %}
                        <p style="color:#ff5252;font-weight:bold;">
                            ⚠️ В наличии только {{ item.product.stock }} шт.! 
                            Измените количество.
                        </p>
                    {% endif %}

                    <!-- Цена с учётом скидки -->
                    {% with discount_info=item.product.get_discount_info %}
                        {% if discount_info.0 > 0 %}
                            <p style="color:#aaa;text-decoration:line-through;">
                                {{ item.product.price }} ₽
                            </p>
                            <p style="font-weight:bold;color:var(--neon-pink);">
                                {{ discount_info.1 }} ₽ за шт.
                            </p>
                        {% else %}
                            <p>{{ item.product.price }} ₽ за шт.</p>
                        {% endif %}
                    {% endwith %}

                    <!-- Управление количеством -->
                    <div style="display:flex;align-items:center;gap:10px;margin:15px 0;">
                        <form method="post" action="{% url 'update_cart' item.product.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="decrease">
                            <button type="submit" class="qty-btn" 
                                {% if item.quantity <= 1 %}disabled{% endif %}>−</button>
                        </form>
                        
                        <span style="font-size:1.2em;font-weight:bold;">{{ item.quantity }}</span>
                        
                        <form method="post" action="{% url 'update_cart' item.product.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="increase">
                            <!-- Ограничиваем максимумом -->
                            {% if item.quantity < item.product.stock %}
                                <button type="submit" class="qty-btn">+</button>
                            {% else %}
                                <button type="submit" class="qty-btn" disabled>+</button>
                            {% endif %}
                        </form>
                        
                        <span style="color:#aaa;font-size:0.9em;">макс. {{ item.product.stock }}</span>
                    </div>

                    <p style="font-weight:bold;color:var(--neon-blue);">Итого: {{ item.total }} ₽</p>

                    <!-- Кнопка удаления -->
                    <form method="post" action="{% url 'update_cart' item.product.id %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="remove">
                        <button type="submit" class="btn" style="color:#ff5252;border-color:#ff5252;padding:5px 12px;font-size:0.9em;">Удалить</button>
                    </form>
                </div>
            </div>
        {% endfor %}

        <div style="text-align:right;font-size:1.4em;font-weight:bold;color:var(--neon-blue);margin:20px 0;">
            Итого: {{ total }} ₽
        </div>

        {% if user.is_authenticated %}
            <div style="text-align:center;margin:30px 0;">
                <a href="{% url 'checkout_page' %}" class="btn" style="color:var(--neon-pink);border-color:var(--neon-pink);padding:14px 35px;font-size:1.2em;">
                    Оформить заказ
                </a>
            </div>
        {% else %}
            <p style="text-align:center;color:#aaa;margin:20px 0;">
                Войдите в аккаунт, чтобы оформить заказ.
            </p>
            <div style="text-align:center;">
                <a href="{% url 'login' %}" class="btn">Войти</a>
            </div>
        {% endif %}

    {% else %}
        <p>Корзина пуста.</p>
        <a href="{% url 'catalog' %}" class="btn">В каталог</a>
    {% endif %}
{% endblock %}